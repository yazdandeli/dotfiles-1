{"version":3,"sources":["out-vscode/vs/workbench/contrib/webview/browser/pre/host.js"],"sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n// @ts-check\n(function () {\n\tconst id = document.location.search.match(/\\bid=([\\w-]+)/)[1];\n\tconst onElectron = /platform=electron/.test(document.location.search);\n\n\tconst hostMessaging = new class HostMessaging {\n\t\tconstructor() {\n\t\t\t/** @type {Map<string, Array<(event: MessageEvent, data: any) => void>>} */\n\t\t\tthis.handlers = new Map();\n\n\t\t\twindow.addEventListener('message', (e) => {\n\t\t\t\tif (e.data && (e.data.command === 'onmessage' || e.data.command === 'do-update-state')) {\n\t\t\t\t\t// Came from inner iframe\n\t\t\t\t\tthis.postMessage(e.data.command, e.data.data);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst channel = e.data.channel;\n\t\t\t\tconst handlers = this.handlers.get(channel);\n\t\t\t\tif (handlers) {\n\t\t\t\t\tfor (const handler of handlers) {\n\t\t\t\t\t\thandler(e, e.data.args);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log('no handler for ', e);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * @param {string} channel\n\t\t * @param {any} data\n\t\t */\n\t\tpostMessage(channel, data) {\n\t\t\twindow.parent.postMessage({ target: id, channel, data }, '*');\n\t\t}\n\n\t\t/**\n\t\t * @param {string} channel\n\t\t * @param {(event: MessageEvent, data: any) => void} handler\n\t\t */\n\t\tonMessage(channel, handler) {\n\t\t\tlet handlers = this.handlers.get(channel);\n\t\t\tif (!handlers) {\n\t\t\t\thandlers = [];\n\t\t\t\tthis.handlers.set(channel, handlers);\n\t\t\t}\n\t\t\thandlers.push(handler);\n\t\t}\n\t}();\n\n\tfunction fatalError(/** @type {string} */ message) {\n\t\tconsole.error(`Webview fatal error: ${message}`);\n\t\thostMessaging.postMessage('fatal-error', { message });\n\t}\n\n\t/** @type {Promise<void>} */\n\tconst workerReady = new Promise(async (resolveWorkerReady) => {\n\t\tif (onElectron) {\n\t\t\treturn resolveWorkerReady();\n\t\t}\n\n\t\tif (!areServiceWorkersEnabled()) {\n\t\t\tfatalError('Service Workers are not enabled in browser. Webviews will not work.');\n\t\t\treturn resolveWorkerReady();\n\t\t}\n\n\t\tconst expectedWorkerVersion = 1;\n\n\t\tnavigator.serviceWorker.register('service-worker.js').then(\n\t\t\tasync registration => {\n\t\t\t\tawait navigator.serviceWorker.ready;\n\n\t\t\t\tconst versionHandler = (event) => {\n\t\t\t\t\tif (event.data.channel !== 'version') {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tnavigator.serviceWorker.removeEventListener('message', versionHandler);\n\t\t\t\t\tif (event.data.version === expectedWorkerVersion) {\n\t\t\t\t\t\treturn resolveWorkerReady();\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// If we have the wrong version, try once to unregister and re-register\n\t\t\t\t\t\treturn registration.update()\n\t\t\t\t\t\t\t.then(() => navigator.serviceWorker.ready)\n\t\t\t\t\t\t\t.finally(resolveWorkerReady);\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tnavigator.serviceWorker.addEventListener('message', versionHandler);\n\t\t\t\tregistration.active.postMessage({ channel: 'version' });\n\t\t\t},\n\t\t\terror => {\n\t\t\t\tfatalError(`Could not register service workers: ${error}.`);\n\t\t\t\tresolveWorkerReady();\n\t\t\t});\n\n\t\tconst forwardFromHostToWorker = (channel) => {\n\t\t\thostMessaging.onMessage(channel, event => {\n\t\t\t\tnavigator.serviceWorker.ready.then(registration => {\n\t\t\t\t\tregistration.active.postMessage({ channel: channel, data: event.data.args });\n\t\t\t\t});\n\t\t\t});\n\t\t};\n\t\tforwardFromHostToWorker('did-load-resource');\n\t\tforwardFromHostToWorker('did-load-localhost');\n\n\t\tnavigator.serviceWorker.addEventListener('message', event => {\n\t\t\tif (['load-resource', 'load-localhost'].includes(event.data.channel)) {\n\t\t\t\thostMessaging.postMessage(event.data.channel, event.data);\n\t\t\t}\n\t\t});\n\t});\n\n\tfunction areServiceWorkersEnabled() {\n\t\ttry {\n\t\t\treturn !!navigator.serviceWorker;\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tconst unloadMonitor = new class {\n\n\t\tconstructor() {\n\t\t\tthis.confirmBeforeClose = 'keyboardOnly';\n\t\t\tthis.isModifierKeyDown = false;\n\n\t\t\thostMessaging.onMessage('set-confirm-before-close', (_e, /** @type {string} */ data) => {\n\t\t\t\tthis.confirmBeforeClose = data;\n\t\t\t});\n\n\t\t\thostMessaging.onMessage('content', (_e, /** @type {any} */ data) => {\n\t\t\t\tthis.confirmBeforeClose = data.confirmBeforeClose;\n\t\t\t});\n\n\t\t\twindow.addEventListener('beforeunload', (event) => {\n\t\t\t\tif (onElectron) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tswitch (this.confirmBeforeClose) {\n\t\t\t\t\tcase 'always':\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\t\t\tevent.returnValue = '';\n\t\t\t\t\t\t\treturn '';\n\t\t\t\t\t\t}\n\t\t\t\t\tcase 'never':\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\tcase 'keyboardOnly':\n\t\t\t\t\tdefault: {\n\t\t\t\t\t\tif (this.isModifierKeyDown) {\n\t\t\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\t\t\tevent.returnValue = '';\n\t\t\t\t\t\t\treturn '';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tonIframeLoaded(/** @type {HTMLIFrameElement} */frame) {\n\t\t\tframe.contentWindow.addEventListener('keydown', e => {\n\t\t\t\tthis.isModifierKeyDown = e.metaKey || e.ctrlKey || e.altKey;\n\t\t\t});\n\n\t\t\tframe.contentWindow.addEventListener('keyup', () => {\n\t\t\t\tthis.isModifierKeyDown = false;\n\t\t\t});\n\t\t}\n\t};\n\n\t/** @type {import('./main').WebviewHost} */\n\tconst host = {\n\t\tpostMessage: hostMessaging.postMessage.bind(hostMessaging),\n\t\tonMessage: hostMessaging.onMessage.bind(hostMessaging),\n\t\tready: workerReady,\n\t\tfakeLoad: !onElectron,\n\t\tonElectron: onElectron,\n\t\tonIframeLoaded: (/** @type {HTMLIFrameElement} */ frame) => {\n\t\t\tunloadMonitor.onIframeLoaded(frame);\n\t\t},\n\t\trewriteCSP: onElectron\n\t\t\t? (csp) => {\n\t\t\t\treturn csp.replace(/vscode-resource:(?=(\\s|;|$))/g, 'vscode-webview-resource:');\n\t\t\t}\n\t\t\t: (csp, endpoint) => {\n\t\t\t\tconst endpointUrl = new URL(endpoint);\n\t\t\t\treturn csp.replace(/(vscode-webview-resource|vscode-resource):(?=(\\s|;|$))/g, endpointUrl.origin);\n\t\t\t}\n\t};\n\n\t(/** @type {any} */ (window)).createWebviewManager(host);\n}());\n"],"mappings":"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","names":[],"file":"host.js"}